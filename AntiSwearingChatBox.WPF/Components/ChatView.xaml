<UserControl
    x:Class="AntiSwearingChatBox.WPF.Components.ChatView"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:converters="clr-namespace:AntiSwearingChatBox.WPF.Converters"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:local="clr-namespace:AntiSwearingChatBox.WPF.Components"
    xmlns:materialDesign="http://materialdesigninxaml.net/winfx/xaml/themes"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    d:DesignHeight="450"
    d:DesignWidth="800"
    mc:Ignorable="d">

    <UserControl.Resources>
        <converters:BoolToColumnConverter x:Key="BoolToColumnConverter" />
        <converters:BoolToAlignmentConverter x:Key="BoolToAlignmentConverter" />
        <converters:MessageBackgroundConverter x:Key="MessageBackgroundConverter" />
        <converters:MessageForegroundConverter x:Key="MessageForegroundConverter" />
        <converters:MessageBorderThicknessConverter x:Key="MessageBorderThicknessConverter" />
        <converters:MessageAlignmentConverter x:Key="MessageAlignmentConverter" />
        <BooleanToVisibilityConverter x:Key="BoolToVisibilityConverter" />
        <converters:InverseBoolToVisibilityConverter x:Key="InverseBoolToVisibilityConverter" />
    </UserControl.Resources>

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="*" />
            <RowDefinition Height="Auto" />
        </Grid.RowDefinitions>

        <!--  Chat Header  -->
        <Border
            Grid.Row="0"
            Padding="16"
            Background="{StaticResource TertiaryBackgroundBrush}"
            BorderBrush="{StaticResource BorderBrush}"
            BorderThickness="0,0,0,1"
            Visibility="{Binding HasSelectedConversation, Converter={StaticResource BoolToVisibilityConverter}}">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="Auto" />
                </Grid.ColumnDefinitions>

                <TextBlock
                    VerticalAlignment="Center"
                    FontSize="16"
                    FontWeight="SemiBold"
                    Foreground="{StaticResource PrimaryTextBrush}"
                    Text="{Binding CurrentContact.Name}" />

                <Button
                    Grid.Column="1"
                    Click="MenuButton_Click"
                    Style="{StaticResource WindowBarButtonStyle}">
                    <TextBlock
                        FontSize="20"
                        Foreground="{StaticResource PrimaryTextBrush}"
                        Text="â‹®" />
                </Button>
            </Grid>
        </Border>

        <!--  Empty State - No Conversation Selected  -->
        <Grid
            Grid.Row="0"
            Grid.RowSpan="3"
            Background="{StaticResource PrimaryBackgroundBrush}"
            Visibility="{Binding HasSelectedConversation, Converter={StaticResource BoolToVisibilityConverter}, ConverterParameter=true}">
            <StackPanel
                MaxWidth="400"
                HorizontalAlignment="Center"
                VerticalAlignment="Center">
                <materialDesign:PackIcon
                    Width="64"
                    Height="64"
                    Margin="0,0,0,16"
                    HorizontalAlignment="Center"
                    Foreground="{StaticResource SecondaryTextBrush}"
                    Kind="ChatOutline" />
                <TextBlock
                    Margin="0,0,0,8"
                    HorizontalAlignment="Center"
                    FontSize="24"
                    FontWeight="SemiBold"
                    Foreground="{StaticResource PrimaryTextBrush}"
                    Text="Select a conversation" />
                <TextBlock
                    Margin="0,0,0,24"
                    FontSize="14"
                    Foreground="{StaticResource SecondaryTextBrush}"
                    Text="Choose an existing conversation from the list or start a new chat to begin messaging."
                    TextAlignment="Center"
                    TextWrapping="Wrap" />
                <Button
                    Width="200"
                    HorizontalAlignment="Center"
                    Click="NewConversationButton_Click"
                    Content="New Conversation"
                    Style="{StaticResource PrimaryButtonStyle}" />
            </StackPanel>
        </Grid>

        <!--  Messages List  -->
        <Grid Grid.Row="1">
            <Image
                Opacity="0.4"
                Source="/Resources/LoginPage/bg.png"
                Stretch="UniformToFill" />
            <Border Background="#121212" Opacity="0.85" />
            <ScrollViewer
                x:Name="MessagesScroll"
                Grid.Row="1"
                Padding="0,12"
                VerticalScrollBarVisibility="Hidden"
                Visibility="{Binding HasSelectedConversation, Converter={StaticResource BoolToVisibilityConverter}}">
                <ItemsControl x:Name="MessagesList" ItemsSource="{Binding Messages}">
                    <ItemsControl.ItemTemplate>
                        <DataTemplate DataType="{x:Type local:ChatMessageViewModel}">
                            <Grid Margin="16,6">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="Auto" />
                                    <ColumnDefinition Width="*" />
                                    <ColumnDefinition Width="Auto" />
                                </Grid.ColumnDefinitions>

                                <!--  Avatar (for received messages)  -->
                                <Border
                                    Grid.Column="0"
                                    Width="36"
                                    Height="36"
                                    Margin="0,0,8,0"
                                    Background="{StaticResource TertiaryBackgroundBrush}"
                                    BorderThickness="0"
                                    CornerRadius="18"
                                    Visibility="{Binding IsSent, Converter={StaticResource InverseBoolToVisibilityConverter}}">
                                    <TextBlock
                                        HorizontalAlignment="Center"
                                        VerticalAlignment="Center"
                                        FontWeight="SemiBold"
                                        Foreground="{StaticResource PrimaryGreenBrush}"
                                        Text="{Binding Avatar}" />
                                </Border>

                                <!--  Message Bubble  -->
                                <Border
                                    x:Name="MessageBubble"
                                    Grid.Column="{Binding IsSent, Converter={StaticResource BoolToColumnConverter}, ConverterParameter=1:1}"
                                    MaxWidth="600"
                                    Padding="12,8"
                                    HorizontalAlignment="{Binding IsSent, Converter={StaticResource MessageAlignmentConverter}}"
                                    Background="{Binding IsSent, Converter={StaticResource MessageBackgroundConverter}}"
                                    BorderBrush="{StaticResource MatchaGreenBrush}"
                                    BorderThickness="{Binding IsSent, Converter={StaticResource MessageBorderThicknessConverter}}"
                                    CornerRadius="18">
                                    <StackPanel>
                                        <TextBlock
                                            FontSize="14"
                                            Foreground="{Binding IsSent, Converter={StaticResource MessageForegroundConverter}}"
                                            Text="{Binding Text}"
                                            TextWrapping="Wrap" />
                                        <TextBlock
                                            Margin="0,4,0,0"
                                            HorizontalAlignment="Right"
                                            FontSize="11"
                                            Foreground="{StaticResource TertiaryTextBrush}"
                                            Text="{Binding Timestamp}" />
                                    </StackPanel>
                                </Border>

                                <!--  Avatar (for sent messages)  -->
                                <Border
                                    Grid.Column="2"
                                    Width="36"
                                    Height="36"
                                    Margin="8,0,0,0"
                                    Background="{StaticResource TertiaryBackgroundBrush}"
                                    BorderThickness="0"
                                    CornerRadius="18"
                                    Visibility="{Binding IsSent, Converter={StaticResource BoolToVisibilityConverter}}">
                                    <TextBlock
                                        HorizontalAlignment="Center"
                                        VerticalAlignment="Center"
                                        FontWeight="SemiBold"
                                        Foreground="{StaticResource PrimaryGreenBrush}"
                                        Text="{Binding Avatar}" />
                                </Border>
                            </Grid>
                        </DataTemplate>
                    </ItemsControl.ItemTemplate>
                </ItemsControl>
            </ScrollViewer>

        </Grid>

        <!--  Message Input  -->
        <Border
            Grid.Row="2"
            Padding="16,12"
            Background="{StaticResource TertiaryBackgroundBrush}">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto" />
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="Auto" />
                </Grid.ColumnDefinitions>

                <Button Click="AttachmentButton_Click" Style="{StaticResource WindowBarButtonStyle}">
                    <TextBlock
                        FontSize="20"
                        Foreground="{StaticResource PrimaryTextBrush}"
                        Text="ðŸ“Ž" />
                </Button>

                <TextBox
                    x:Name="MessageTextBox"
                    Grid.Column="1"
                    Margin="10,0"
                    AcceptsReturn="False"
                    Background="{StaticResource SecondaryBackgroundBrush}"
                    CaretBrush="{StaticResource PrimaryGreenBrush}"
                    Foreground="{StaticResource PrimaryTextBrush}"
                    Style="{StaticResource ChatInputStyle}" />

                <Button
                    Grid.Column="2"
                    Background="{StaticResource PrimaryGreenBrush}"
                    Click="SendButton_Click"
                    Style="{StaticResource WindowBarButtonStyle}">
                    <TextBlock
                        FontSize="18"
                        Foreground="White"
                        Text="âž¤" />
                </Button>
            </Grid>
        </Border>
    </Grid>
</UserControl> 